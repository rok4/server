
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://rok4.github.io/server/5.5.0/">
      
      
      
        <link rel="next" href="openapi/">
      
      
      <link rel="icon" href="https://rok4.github.io/assets/images/rok4-carre.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://rok4.github.io/assets/css/commun.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#serveur-de-diffusion-wms-wmts-et-tms" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  üö® Vous √™tes sur la documentation d'une ancienne version. üö®
  <a href="../."> 
    <strong>Cliquez ici pour aller sur la derni√®re version.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-t√™te">
    <a href="https://rok4.github.io" title="Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS" class="md-header__button md-logo" aria-label="Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS" data-md-component="logo">
      
  <img src="https://rok4.github.io/assets/images/rok4-carre.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Accueil
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="." class="md-tabs__link">
        
  
    
  
  Accueil

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="openapi/" class="md-tabs__link">
        
  
    
  
  Sp√©cification de l'API

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="documentation/" class="md-tabs__link">
        
  
    
  
  Documentation technique

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="CHANGELOG/" class="md-tabs__link">
        
  
    
  
  Historique des versions

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="CONTRIBUTING/" class="md-tabs__link">
        
  
    
  
  Contribuer

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://rok4.github.io" title="Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS" class="md-nav__button md-logo" aria-label="Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS" data-md-component="logo">
      
  <img src="https://rok4.github.io/assets/images/rok4-carre.png" alt="logo">

    </a>
    Projet ROK4 - Serveur de diffusion WMS, WMTS et TMS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Accueil
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Accueil
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des mati√®res">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des mati√®res
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installer-le-serveur-outils-debian" class="md-nav__link">
    <span class="md-ellipsis">
      Installer le serveur outils (Debian)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utiliser-le-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Utiliser le serveur
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Utiliser le serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#variables-denvironnement-utilisees" class="md-nav__link">
    <span class="md-ellipsis">
      Variables d'environnement utilis√©es
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configurer-le-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Configurer le serveur
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lancer-le-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Lancer le serveur
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lancer le serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#en-ligne-de-commande" class="md-nav__link">
    <span class="md-ellipsis">
      En ligne de commande
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#en-tant-que-service-systemctl" class="md-nav__link">
    <span class="md-ellipsis">
      En tant que service systemctl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installer-et-configurer-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      Installer et configurer NGINX
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acces-aux-capacites-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Acc√®s aux capacit√©s du serveur
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fonctionnement-general-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Fonctionnement g√©n√©ral du serveur
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fonctionnement g√©n√©ral du serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identification-du-service-et-du-type-de-requete" class="md-nav__link">
    <span class="md-ellipsis">
      Identification du service et du type de requ√™te
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acces-aux-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      Acc√®s aux donn√©es
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gestion-des-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Gestion des configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#personnalisation-des-points-dacces-aux-services" class="md-nav__link">
    <span class="md-ellipsis">
      Personnalisation des points d'acc√®s aux services
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiler-le-serveur-debian" class="md-nav__link">
    <span class="md-ellipsis">
      Compiler le serveur (Debian)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compiler le serveur (Debian)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependances-supplementaires" class="md-nav__link">
    <span class="md-ellipsis">
      D√©pendances suppl√©mentaires
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variables-cmake" class="md-nav__link">
    <span class="md-ellipsis">
      Variables CMake
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation-tests-unitaires-et-documentation-et-installation" class="md-nav__link">
    <span class="md-ellipsis">
      Compilation, tests unitaires et documentation et installation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contribuer" class="md-nav__link">
    <span class="md-ellipsis">
      Contribuer
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="openapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sp√©cification de l'API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Documentation technique
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="CHANGELOG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historique des versions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribuer
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des mati√®res">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des mati√®res
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installer-le-serveur-outils-debian" class="md-nav__link">
    <span class="md-ellipsis">
      Installer le serveur outils (Debian)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utiliser-le-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Utiliser le serveur
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Utiliser le serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#variables-denvironnement-utilisees" class="md-nav__link">
    <span class="md-ellipsis">
      Variables d'environnement utilis√©es
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configurer-le-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Configurer le serveur
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lancer-le-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Lancer le serveur
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lancer le serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#en-ligne-de-commande" class="md-nav__link">
    <span class="md-ellipsis">
      En ligne de commande
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#en-tant-que-service-systemctl" class="md-nav__link">
    <span class="md-ellipsis">
      En tant que service systemctl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installer-et-configurer-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      Installer et configurer NGINX
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acces-aux-capacites-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Acc√®s aux capacit√©s du serveur
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fonctionnement-general-du-serveur" class="md-nav__link">
    <span class="md-ellipsis">
      Fonctionnement g√©n√©ral du serveur
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fonctionnement g√©n√©ral du serveur">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identification-du-service-et-du-type-de-requete" class="md-nav__link">
    <span class="md-ellipsis">
      Identification du service et du type de requ√™te
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acces-aux-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      Acc√®s aux donn√©es
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gestion-des-configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Gestion des configurations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#personnalisation-des-points-dacces-aux-services" class="md-nav__link">
    <span class="md-ellipsis">
      Personnalisation des points d'acc√®s aux services
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compiler-le-serveur-debian" class="md-nav__link">
    <span class="md-ellipsis">
      Compiler le serveur (Debian)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compiler le serveur (Debian)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependances-supplementaires" class="md-nav__link">
    <span class="md-ellipsis">
      D√©pendances suppl√©mentaires
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variables-cmake" class="md-nav__link">
    <span class="md-ellipsis">
      Variables CMake
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation-tests-unitaires-et-documentation-et-installation" class="md-nav__link">
    <span class="md-ellipsis">
      Compilation, tests unitaires et documentation et installation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contribuer" class="md-nav__link">
    <span class="md-ellipsis">
      Contribuer
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="serveur-de-diffusion-wms-wmts-et-tms">Serveur de diffusion WMS, WMTS et TMS</h1>
<p><img alt="ROK4 Logo" src="https://rok4.github.io/assets/images/rok4.png" /></p>
<p>Le serveur impl√©mente les standards ouverts de l‚ÄôOpen Geospatial Consortium (OGC) WMS 1.3.0, WMTS 1.0.0 et OGC API Tiles 1.0.0, ainsi que le TMS (Tile Map Service). Il vise deux objectifs principaux :</p>
<ul>
<li>L‚Äôutilisation d‚Äôun cache de donn√©es raster unique permettant de servir indiff√©remment des flux WMS, WMTS, API Tiles et TMS</li>
<li>Des performances de traitement d‚Äôimage et de diffusion accrues</li>
<li>La diffusion de tuiles vecteur telles qu'elles sont stock√©es, sans transformation (TMS uniquement)</li>
<li>La diffusion en WMTS selon des Tile Matrix Sets diff√©rents de celui de la pyramide utilis√©e.</li>
</ul>
<p>Les pyramides de donn√©es utilis√©es sont produites via les outils de <a href="https://github.com/rok4/pregeneration">pr√©g√©n√©ration</a> et de <a href="https://github.com/rok4/generation">g√©n√©ration</a>.</p>
<p>L'impl√©mentation s'appuie essentiellement sur la <a href="https://github.com/rok4/core-cpp">librairie C++ du projet</a>.</p>
<h2 id="installer-le-serveur-outils-debian">Installer le serveur outils (Debian)</h2>
<p>Installations syst√®me requises (list√©es dans le paquet debian, install√©es avec l'applicatif lors du <code>apt install</code>) :</p>
<ul>
<li><code>librok4-dev</code> (disponible sur <a href="https://github.com/rok4/core-cpp/releases/">GitHub</a>)</li>
<li><code>libcurl4-openssl-dev</code></li>
<li><code>libssl-dev</code></li>
<li><code>libfcgi-dev</code></li>
<li><code>libtinyxml-dev</code></li>
<li><code>libproj-dev</code></li>
<li><code>libboost-log-dev</code></li>
<li><code>libboost-filesystem-dev</code></li>
<li><code>libboost-system-dev</code></li>
</ul>
<pre><code class="language-bash">### librok4-dev
curl -o librok4-dev.deb https://github.com/rok4/core-cpp/releases/download/5.5.0/librok4-base-5.5.0-ubuntu-20.04-amd64.deb
# or, with ceph driver
curl -o librok4-dev.deb https://github.com/rok4/core-cpp/releases/download/5.5.0/librok4-ceph-5.5.0-ubuntu-20.04-amd64.deb

apt install ./librok4-dev.deb

### rok4-server
curl -o rok4-server.deb https://github.com/rok4/server/releases/download/5.5.0/rok4-server-5.5.0-ubuntu-20.04-amd64.deb

apt install ./rok4-server.deb

### installation des styles et des tile matrix sets 
curl -o tilematrixsets.deb https://github.com/rok4/tilematrixsets/releases/download/4.1/rok4-tilematrixsets-4.1-linux-all.deb
apt install ./tilematrixsets.deb

curl -o styles.deb https://github.com/rok4/styles/releases/download/4.1/rok4-styles-4.1-linux-all.deb
apt install ./rok4-styles.deb
</code></pre>
<h2 id="utiliser-le-serveur">Utiliser le serveur</h2>
<p>Le serveur ROK4 est lanc√© en mode stand alone. Nous utiliserons ici Nginx comme serveur front pour "traduire" les requ√™tes HTTP en FCGI et les rediriger vers le serveur ROK4.</p>
<h3 id="variables-denvironnement-utilisees">Variables d'environnement utilis√©es</h3>
<p>Leur d√©finition est contr√¥l√©e √† l'usage.</p>
<ul>
<li>Pour le stockage CEPH<ul>
<li><code>ROK4_CEPH_CONFFILE</code></li>
<li><code>ROK4_CEPH_USERNAME</code></li>
<li><code>ROK4_CEPH_CLUSTERNAME</code></li>
</ul>
</li>
<li>Pour le stockage S3<ul>
<li><code>ROK4_S3_URL</code></li>
<li><code>ROK4_S3_KEY</code></li>
<li><code>ROK4_S3_SECRETKEY</code></li>
</ul>
</li>
<li>Pour le stockage SWIFT<ul>
<li><code>ROK4_SWIFT_AUTHURL</code></li>
<li><code>ROK4_SWIFT_USER</code></li>
<li><code>ROK4_SWIFT_PASSWD</code></li>
<li><code>ROK4_SWIFT_PUBLICURL</code></li>
<li>Si authentification via Swift<ul>
<li><code>ROK4_SWIFT_ACCOUNT</code></li>
</ul>
</li>
<li>Si connection via keystone (pr√©sence de <code>ROK4_KEYSTONE_DOMAINID</code>)<ul>
<li><code>ROK4_KEYSTONE_DOMAINID</code></li>
<li><code>ROK4_KEYSTONE_PROJECTID</code></li>
</ul>
</li>
<li><code>ROK4_SWIFT_TOKEN_FILE</code> afin de sauvegarder le token d'acc√®s, et ne pas le demander si ce fichier en contient un</li>
</ul>
</li>
<li>Pour configurer l'usage de libcurl (int√©raction SWIFT et S3)<ul>
<li><code>ROK4_SSL_NO_VERIFY</code></li>
<li><code>HTTP_PROXY</code></li>
<li><code>HTTPS_PROXY</code></li>
<li><code>NO_PROXY</code></li>
</ul>
</li>
</ul>
<h3 id="configurer-le-serveur">Configurer le serveur</h3>
<p>Dans le fichier <code>server.json</code>, on pr√©cise le port d'√©coute :</p>
<pre><code class="language-json">    &quot;port&quot;: &quot;:9000&quot;
</code></pre>
<p>On configure les logs de mani√®re √† les retrouver dans un fichier par jour :</p>
<pre><code class="language-json">&quot;logger&quot;: {
    &quot;output&quot;: &quot;rolling_file&quot;,
    &quot;level&quot;: &quot;info&quot;,
    &quot;file_prefix&quot;: &quot;/var/log/rok4&quot;,
    &quot;file_period&quot;: 86400
}
</code></pre>
<p>Les r√©pertoires dans lesquels sont les tile matrix sets et les styles peuvent √™tre des dossiers (comme <code>file:///usr/share/rok4/tilematrixsets</code>) ou des pr√©fixes objets  (comme <code>s3://tilematrixsets</code>). Sans pr√©fixe pr√©cisant le type de stockage, le chemin est interpr√©t√© en mode fichier.</p>
<ul>
<li>Les param√®tres possibles du fichier de configuration <code>server.json</code> sont d√©crits <a href="config/server.schema.json">ici</a></li>
<li>Les param√®tres possibles du fichier de configuration <code>services.json</code> sont d√©crits <a href="config/services.schema.json">ici</a></li>
</ul>
<h3 id="lancer-le-serveur">Lancer le serveur</h3>
<h4 id="en-ligne-de-commande">En ligne de commande</h4>
<p>La ligne de commande permettant de lancer ROK4 comme instance autonome est la suivante :</p>
<pre><code class="language-bash">rok4 -f /chemin/vers/fichier/server.json &amp;
</code></pre>
<h4 id="en-tant-que-service-systemctl">En tant que service systemctl</h4>
<p>Selon l'emplacement d'installation, le fichier dans <code>service/rok4.service</code> peut d√©j√† √™tre √† un endroit pris en compte par systemctl (comme <code>/usr/lib/systemd/system</code>). Celui ci est √©crit pour un d√©ploiement √† la racine, modifiez les chemins pour qu'il soit adapt√© √† votre d√©ploiement. Si l'installation a √©t√© faite via le paquet debian, le service est d√©j√† correctement install√©, et les configurations sont dans <code>/etc/rok4</code>.</p>
<pre><code>EnvironmentFile=/etc/rok4/env
WorkingDirectory=/etc/rok4/
</code></pre>
<p>Le fichier <code>/etc/rok4/env</code> permet de d√©finir les variables d'environnement propres au serveur pour configurer l'utilisation de stockages objets (voir <a href="#variables-denvironnement-utilis√©es">ici</a>).</p>
<p>Le serveur est lanc√© en tant que user (et group) <code>rok4</code>. Il convient donc de le cr√©er : <code>useradd rok4</code>.</p>
<p>Il suffit alors de recharger le d√©mon systemctl avec la commande <code>systemctl daemon-reload</code>. Vous pouvez maintenant piloter le serveur ROK4 via ce syst√®me, comme le d√©marrer avec <code>systemctl start rok4</code>.</p>
<h3 id="installer-et-configurer-nginx">Installer et configurer NGINX</h3>
<ul>
<li>Sous Debian : <code>apt install nginx</code></li>
<li>Sous Centos : <code>yum install nginx</code></li>
</ul>
<p>Remplacer le fichier <code>default</code> pr√©sent dans le r√©pertoire <code>/etc/nginx/sites-enabled</code> par le contenu suivant :</p>
<pre><code>upstream rok4 { server localhost:9000; }

server {
    listen 80;
    root /var/www;
    server_name localhost;

    access_log /var/log/rok4_access.log;
    error_log /var/log/rok4_error.log;

    location /rok4 {
        rewrite /rok4/?(.*) /$1 break;
        fastcgi_pass rok4;
        include fastcgi_params;
    }
}
</code></pre>
<p>On red√©marre nginx : <code>systemctl restart nginx</code></p>
<h3 id="acces-aux-capacites-du-serveur">Acc√®s aux capacit√©s du serveur</h3>
<ul>
<li>Liste des services de diffusion : http://localhost/rok4/</li>
<li>GetCapabilities des services de diffusion<ul>
<li>WMS : http://localhost/rok4/wms?request=GetCapabilities&amp;service=WMS</li>
<li>WMTS : http://localhost/rok4/wmts?request=GetCapabilities&amp;service=WMTS</li>
<li>TMS : http://localhost/rok4/tms/1.0.0</li>
<li>OGC API Tiles : http://localhost/rok4/ogcapitiles/collections</li>
</ul>
</li>
<li>Racine de l'API d'administration : http://localhost/rok4/admin/</li>
<li>√âtat de sant√© du serveur : http://localhost/rok4/healthcheck</li>
</ul>
<h2 id="fonctionnement-general-du-serveur">Fonctionnement g√©n√©ral du serveur</h2>
<h3 id="identification-du-service-et-du-type-de-requete">Identification du service et du type de requ√™te</h3>
<p>Lorsque le serveur re√ßoit une requ√™te, c'est le premier √©l√©ment du chemin qui d√©termine le service :</p>
<ul>
<li><code>/</code> -&gt; requ√™te globale</li>
<li><code>/healthcheck</code> -&gt; requ√™te d'√©tat de sant√© ou statut du serveur</li>
<li><code>/wmts</code> -&gt; requ√™te WMTS</li>
<li><code>/wms</code> -&gt; requ√™te WMS</li>
<li><code>/ogcapitiles</code> -&gt; requ√™te API Tiles</li>
<li><code>/tms</code> -&gt; requ√™te TMS</li>
<li><code>/admin</code> -&gt; requ√™te d'administration</li>
</ul>
<p>En WMS et WMTS, si c'est une requ√™te POST, le corps est interpr√©t√© pour extraire les informations. Seuls le getCapabilities, le getMap et le getTile sont disponibles en POST. Le param√®tre de requ√™te ou le corps doit confirmer le service pour que la requ√™te soit valide.</p>
<p>Les requ√™tes g√©r√©es par le serveur sont d√©crites dans des sp√©cifications au format <a href="openapi.yaml">Open API</a>.</p>
<h3 id="acces-aux-donnees">Acc√®s aux donn√©es</h3>
<p>L'acc√®s aux donn√©es stock√©es dans les pyramides se fait toujours par tuile. Dans le cas du TMS et WMTS, la requ√™te doit contenir les indices (colonne et ligne) de la tuile voulue. La tuile est ensuite renvoy√©e sans traitement, ou avec simple ajout/modification de l'en-t√™te (en TIFF et en PNG). Dans le cas d'un GetMap en WMS, l'emprise demand√©e est convertie dans le syst√®me de coordonn√©es de la pyramide, et on identifie ainsi la liste des indices des tuiles requises pour calcul√©e l'image voulue. De la m√™me mani√®re qu'en WMTS et TMS, le serveur sait √† partir des indices o√π r√©cup√©rer la donn√©e dans l'espace de stockage des pyramides.</p>
<p>Avec les indices de la tuile √† lire, le serveur calcule le nom de la dalle qui la contient et le num√©ro de la tuile dans cette dalle. Le serveur commence par r√©cup√©rer le header et l'index de la dalle, contenant les offsets et les tailles de toutes les tuiles de la dalle. Le header fait toujours 2048 octets et l'index a une taille connue par le serveur.</p>
<p>Dans le cas du stockage objet (CEPH, S3, SWIFT), les objets symboliques ne font jamais plus de 2047 octets. Cette premi√®re lecture permet donc de les identifier (on lit moins que voulu). Dans ce cas, ce qu'on a lu contient le nom de l'objet contenant r√©ellement la donn√©e (pr√©c√©d√© de la signature <code>SYMLINK#</code>). On va donc reproduire l'op√©ration sur ce nouvel objet, qui lui ne doit pas √™tre un objet symbolique (pas de lien en cascade). En mode fichier, ce m√©canisme est transparent pour le serveur car g√©r√© par le syst√®me de fichiers.</p>
<p>Une fois que l'on a r√©cup√©r√© l'index, et gr√¢ce au num√©ro de la tuile dans la dalle, on va pouvoir conna√Ætre l'offset et la taille. On va donc faire une deuxi√®me lecture de la dalle pour r√©cup√©rer la donn√©e de la tuile.</p>
<h3 id="gestion-des-configurations">Gestion des configurations</h3>
<p>Au d√©marrage du serveur, le fichier de configuration globale du serveur est charg√©, puis celui des services. Si un fichier / objet est pr√©cis√© pour les couches, il est lu. C'est interpr√©t√© comme la liste des chemins vers les descripteurs des couches √† charger √† l'initialisation. Sinon, le serveur ne contient aucune couche.</p>
<p>Lorsqu'une couche est charg√©e, les descripteurs de pyramide, de TMS et de styles n√©cessaire sont charg√©s √† la vol√©e. </p>
<pre><code class="language-json">    &quot;configurations&quot;: {
        &quot;services&quot;: &quot;/etc/rok4/services.json&quot;,
        &quot;layers&quot;: &quot;s3://layers/list.txt&quot;,
        &quot;styles&quot;: &quot;file:///usr/share/rok4/styles&quot;,
        &quot;tile_matrix_sets&quot;: &quot;file:///usr/share/rok4/tilematrixsets&quot;
    }
</code></pre>
<p>Pour les TMS et les styles, ils sont cherch√©s dans les r√©pertoires (fichier ou objet) renseign√©s dans le <code>server.json</code>, avec comme nom de fichier objet <code>&lt;ID du style&gt;.json</code>. Un annuaire est tenu √† jour pour ne charger qu'une seule fois le style ou le TMS.</p>
<p><img alt="Chargement du serveur" src="images/rok4server-layer-pyramid.png" /></p>
<h3 id="personnalisation-des-points-dacces-aux-services">Personnalisation des points d'acc√®s aux services</h3>
<p>Pour que les URLs pr√©sentes dans les r√©ponses des services soient correctes malgr√© des r√©ecritures, il est important de bien renseigner les champs suivant dans le fichier <code>services.json</code>:</p>
<pre><code class="language-json">    &quot;wms&quot;: {
        &quot;endpoint_uri&quot;: &quot;http://localhost/rok4/wms&quot;,
    },
    &quot;wmts&quot;: {
        &quot;endpoint_uri&quot;: &quot;http://localhost/rok4/wmts&quot;
    },
    &quot;tms&quot;: {
        &quot;endpoint_uri&quot;: &quot;http://localhost/rok4/tms&quot;
    },
    &quot;ogctiles&quot;: {
        &quot;endpoint_uri&quot;: &quot;http://localhost/rok4/ogcapitiles&quot;
    }
</code></pre>
<h2 id="compiler-le-serveur-debian">Compiler le serveur (Debian)</h2>
<h3 id="dependances-supplementaires">D√©pendances suppl√©mentaires</h3>
<ul>
<li><code>build-essential</code></li>
<li><code>cmake</code></li>
<li>Pour les tests unitaires<ul>
<li><code>libcppunit-dev</code></li>
</ul>
</li>
<li>Pour la documentation<ul>
<li><code>doxygen</code></li>
<li><code>graphviz</code></li>
</ul>
</li>
</ul>
<p><code>apt install build-essential cmake libcppunit-dev doxygen graphviz</code> </p>
<h3 id="variables-cmake">Variables CMake</h3>
<ul>
<li><code>UNITTEST_ENABLED</code> : active la compilation des tests unitaires. Valeur par d√©faut : <code>1</code>, <code>0</code> pour d√©sactiver.</li>
<li><code>DOC_ENABLED</code> : active la compilation de la documentation. Valeur par d√©faut : <code>1</code>, <code>0</code> pour d√©sactiver.</li>
<li><code>BUILD_VERSION</code> : version de la librairie compil√©e. Valeur par d√©faut : <code>0.0.0</code>. Utile pour la compilation de la documentation.</li>
<li><code>DEBUG_BUILD</code> : active la compilation en mode debug. Valeur par d√©faut : <code>0</code>, <code>1</code> pour activer.</li>
</ul>
<h3 id="compilation-tests-unitaires-et-documentation-et-installation">Compilation, tests unitaires et documentation et installation</h3>
<pre><code class="language-bash">mkdir build &amp;&amp; cd build
cmake -DBUILD_VERSION=0.0.0 -DCMAKE_INSTALL_PREFIX=/opt/rok4 ..
make
make test
make doc
make install
</code></pre>
<h2 id="contribuer">Contribuer</h2>
<p>Consulter les <a href="CONTRIBUTING/">directives de contribution</a></p>







  
  




  



                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>